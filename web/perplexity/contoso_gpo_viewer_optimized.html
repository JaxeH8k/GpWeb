<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contoso GPO Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .welcome {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .upload-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: #f8f9fa;
        }

        .upload-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .status {
            margin-top: 10px;
            font-size: 0.9em;
            color: #28a745;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            display: none;
        }

        .debug-info.visible {
            display: block;
        }

        .debug-info h3 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 1em;
        }

        .tree-container {
            margin-top: 30px;
            display: none;
        }

        .tree-container.visible {
            display: block;
        }

        .ou-item {
            margin: 5px 0;
        }

        .ou-header {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .ou-header:hover {
            background: #f0f0f0;
        }

        .expand-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 8px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .expand-btn.collapsed {
            background: #28a745;
            color: white;
        }

        .expand-btn.expanded {
            background: #dc3545;
            color: white;
        }

        .expand-btn:disabled {
            background: #e0e0e0;
            cursor: default;
            visibility: hidden;
        }

        .ou-name {
            font-weight: 600;
            color: #333;
            margin-right: 10px;
        }

        .gpo-count {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
        }

        .ou-children {
            margin-left: 32px;
            display: none;
        }

        .ou-children.visible {
            display: block;
        }

        .gpo-item {
            padding: 8px 8px 8px 32px;
            margin: 2px 0;
            background: #f8f9fa;
            border-left: 3px solid #667eea;
            border-radius: 3px;
        }

        .gpo-name {
            font-weight: 500;
            color: #495057;
        }

        .gpo-name.has-wmi {
            font-style: italic;
        }

        .wmi-details {
            margin-top: 5px;
            margin-left: 15px;
            font-size: 0.85em;
            color: #6c757d;
            line-height: 1.4;
        }

        .wmi-name {
            font-weight: 600;
            color: #764ba2;
        }

        .wmi-query {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 3px 6px;
            border-radius: 3px;
            margin-top: 3px;
            display: inline-block;
            max-width: 100%;
            word-break: break-all;
        }

        .error-msg {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ Contoso Group Policy Management</h1>
        <p class="welcome">Welcome to the enhanced GPO viewer. Upload your JSON files to explore your Active Directory Group Policy infrastructure with improved performance.</p>

        <div class="upload-section">
            <div class="upload-box">
                <h3>üìÅ OU JSON</h3>
                <input type="file" id="ouFile" class="file-input" accept=".json">
                <button class="upload-btn" onclick="document.getElementById('ouFile').click()">Select File</button>
                <div class="status" id="ouStatus"></div>
            </div>

            <div class="upload-box">
                <h3>üìã GPO JSON</h3>
                <input type="file" id="gpoFile" class="file-input" accept=".json">
                <button class="upload-btn" onclick="document.getElementById('gpoFile').click()">Select File</button>
                <div class="status" id="gpoStatus"></div>
            </div>

            <div class="upload-box">
                <h3>üîç WMI JSON</h3>
                <input type="file" id="wmiFile" class="file-input" accept=".json">
                <button class="upload-btn" onclick="document.getElementById('wmiFile').click()">Select File</button>
                <div class="status" id="wmiStatus"></div>
            </div>
        </div>

        <div class="debug-info" id="debugInfo">
            <h3>üìä Debug Information</h3>
            <div id="debugContent"></div>
        </div>

        <div class="tree-container" id="treeContainer">
            <h2>Organizational Unit Hierarchy</h2>
            <div id="ouTree"></div>
        </div>
    </div>

    <script>
        let ouData = null;
        let gpoData = null;
        let wmiData = null;

        // Performance-optimized indexes using Map (O(1) lookups)
        let gpoIndex = null;
        let wmiIndex = null;

        // File upload handlers
        document.getElementById('ouFile').addEventListener('change', (e) => handleFileUpload(e, 'ou'));
        document.getElementById('gpoFile').addEventListener('change', (e) => handleFileUpload(e, 'gpo'));
        document.getElementById('wmiFile').addEventListener('change', (e) => handleFileUpload(e, 'wmi'));

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            console.log(`Loading ${type} file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const startTime = performance.now();
                    const data = JSON.parse(e.target.result);
                    const parseTime = (performance.now() - startTime).toFixed(2);

                    console.log(`${type} parsed in ${parseTime}ms, ${data.length} items`);

                    switch(type) {
                        case 'ou':
                            ouData = data;
                            document.getElementById('ouStatus').textContent = `‚úì ${file.name} (${data.length} OUs)`;
                            break;
                        case 'gpo':
                            gpoData = data;
                            buildGPOIndex();
                            document.getElementById('gpoStatus').textContent = `‚úì ${file.name} (${data.length} GPOs)`;
                            break;
                        case 'wmi':
                            wmiData = data;
                            buildWMIIndex();
                            document.getElementById('wmiStatus').textContent = `‚úì ${file.name} (${data.length} filters)`;
                            break;
                    }

                    if (ouData && gpoData && wmiData) {
                        renderOUTree();
                    }
                } catch (error) {
                    console.error(`Error parsing ${file.name}:`, error);
                    alert(`Error parsing ${file.name}: ${error.message}`);
                }
            };

            reader.onerror = (error) => {
                console.error(`Error reading ${file.name}:`, error);
                alert(`Error reading ${file.name}`);
            };

            reader.readAsText(file);
        }

        // Build index for O(1) GPO lookups instead of O(n) Array.find()
        function buildGPOIndex() {
            console.log('Building GPO index...');
            const startTime = performance.now();

            gpoIndex = new Map();
            gpoData.forEach(gpo => {
                if (gpo.Id) {
                    // Normalize GUIDs - store both with and without braces
                    const normalizedId = gpo.Id.replace(/[{}]/g, '').toLowerCase();
                    gpoIndex.set(normalizedId, gpo);
                    gpoIndex.set(`{${normalizedId}}`, gpo);
                    gpoIndex.set(gpo.Id.toLowerCase(), gpo);
                }
            });

            const indexTime = (performance.now() - startTime).toFixed(2);
            console.log(`GPO index built in ${indexTime}ms, ${gpoIndex.size} entries`);
        }

        // Build index for O(1) WMI lookups
        function buildWMIIndex() {
            console.log('Building WMI index...');
            const startTime = performance.now();

            wmiIndex = new Map();
            wmiData.forEach(wmi => {
                if (wmi['msWMI-ID']) {
                    const wmiId = wmi['msWMI-ID'];
                    // Store multiple variations for matching
                    const normalizedId = wmiId.replace(/[{}]/g, '').toLowerCase();
                    wmiIndex.set(normalizedId, wmi);
                    wmiIndex.set(`{${normalizedId}}`, wmi);
                    wmiIndex.set(wmiId.toLowerCase(), wmi);
                }
            });

            const indexTime = (performance.now() - startTime).toFixed(2);
            console.log(`WMI index built in ${indexTime}ms, ${wmiIndex.size} entries`);
        }

        function extractGuidFromPath(path) {
            // Extract GUID from various CN= formats
            const patterns = [
                /CN=\{([^}]+)\}/i,  // CN={GUID}
                /\{([a-f0-9-]+)\}/i, // {GUID} anywhere
                /([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/i // GUID pattern
            ];

            for (const pattern of patterns) {
                const match = path.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            return null;
        }

        function findGPO(guid) {
            if (!guid || !gpoIndex) return null;

            // Try normalized lookup (O(1) instead of O(n))
            const normalized = guid.replace(/[{}]/g, '').toLowerCase();
            return gpoIndex.get(normalized) || 
                   gpoIndex.get(`{${normalized}}`) || 
                   gpoIndex.get(guid.toLowerCase()) || 
                   null;
        }

        function findWMI(guid) {
            if (!guid || !wmiIndex) return null;

            // Try normalized lookup (O(1) instead of O(n))
            const normalized = guid.replace(/[{}]/g, '').toLowerCase();
            return wmiIndex.get(normalized) || 
                   wmiIndex.get(`{${normalized}}`) || 
                   wmiIndex.get(guid.toLowerCase()) || 
                   null;
        }

        function buildOUHierarchy() {
            console.log('Building OU hierarchy...');
            const startTime = performance.now();

            const ouMap = new Map();
            const rootOUs = [];
            let totalGPOs = 0;
            let matchedGPOs = 0;
            let unmatchedGUIDs = new Set();

            try {
                // Create a map of all OUs
                ouData.forEach((ou, index) => {
                    const ouPath = `OU=${ou.Name},${ou.Parent}`;
                    ouMap.set(ouPath, {
                        ...ou,
                        fullPath: ouPath,
                        children: [],
                        gpos: []
                    });
                });

                console.log(`Created ${ouMap.size} OU entries`);

                // Build parent-child relationships and process GPOs
                ouData.forEach(ou => {
                    const ouPath = `OU=${ou.Name},${ou.Parent}`;
                    const ouNode = ouMap.get(ouPath);

                    if (!ouNode) {
                        console.warn(`OU node not found for: ${ouPath}`);
                        return;
                    }

                    // Find children
                    ouData.forEach(potentialChild => {
                        if (potentialChild.Parent === ouPath) {
                            const childPath = `OU=${potentialChild.Name},${potentialChild.Parent}`;
                            const childNode = ouMap.get(childPath);
                            if (childNode) {
                                ouNode.children.push(childNode);
                            }
                        }
                    });

                    // Process linked GPOs
                    if (ou.LinkedGPO && ou.LinkedGPO.length > 0) {
                        totalGPOs += ou.LinkedGPO.length;

                        ou.LinkedGPO.forEach(gpoPath => {
                            const guid = extractGuidFromPath(gpoPath);

                            if (guid) {
                                const gpo = findGPO(guid);

                                if (gpo) {
                                    matchedGPOs++;
                                    let wmiInfo = null;

                                    if (gpo.WmiFilter && gpo.WmiFilter.Path) {
                                        const wmiGuid = extractGuidFromPath(gpo.WmiFilter.Path);
                                        if (wmiGuid) {
                                            wmiInfo = findWMI(wmiGuid);
                                        }
                                    }

                                    ouNode.gpos.push({ gpo, wmiInfo });
                                } else {
                                    unmatchedGUIDs.add(guid);
                                    console.warn(`GPO not found for GUID: ${guid} in OU: ${ou.Name}`);
                                }
                            } else {
                                console.warn(`Could not extract GUID from path: ${gpoPath}`);
                            }
                        });
                    }

                    // Add to root if parent is domain root
                    if (ou.Parent.startsWith('DC=')) {
                        rootOUs.push(ouNode);
                    }
                });

                const hierarchyTime = (performance.now() - startTime).toFixed(2);

                // Display debug info
                const debugContent = `
                    <strong>OUs:</strong> ${ouMap.size}<br>
                    <strong>Root OUs:</strong> ${rootOUs.length}<br>
                    <strong>Total GPO Links:</strong> ${totalGPOs}<br>
                    <strong>Matched GPOs:</strong> ${matchedGPOs}<br>
                    <strong>Unmatched GPOs:</strong> ${unmatchedGUIDs.size}<br>
                    <strong>Processing Time:</strong> ${hierarchyTime}ms<br>
                    ${unmatchedGUIDs.size > 0 ? `<strong style="color: #dc3545;">Unmatched GUIDs:</strong> ${Array.from(unmatchedGUIDs).slice(0, 5).join(', ')}${unmatchedGUIDs.size > 5 ? '...' : ''}` : ''}
                `;

                document.getElementById('debugContent').innerHTML = debugContent;
                document.getElementById('debugInfo').classList.add('visible');

                console.log(`Hierarchy built: ${matchedGPOs}/${totalGPOs} GPOs matched, ${unmatchedGUIDs.size} unmatched`);

                return rootOUs;

            } catch (error) {
                console.error('Error building hierarchy:', error);
                document.getElementById('debugContent').innerHTML = `<strong style="color: #dc3545;">ERROR:</strong> ${error.message}`;
                document.getElementById('debugInfo').classList.add('visible');
                throw error;
            }
        }

        function toggleOU(button, contentId) {
            const content = document.getElementById(contentId);
            if (content.classList.contains('visible')) {
                content.classList.remove('visible');
                button.classList.remove('expanded');
                button.classList.add('collapsed');
                button.textContent = '+';
            } else {
                content.classList.add('visible');
                button.classList.remove('collapsed');
                button.classList.add('expanded');
                button.textContent = '‚àí';
            }
        }

        function renderOUNode(ou, level = 0) {
            const hasChildren = ou.children.length > 0 || ou.gpos.length > 0;
            const uniqueId = `ou_${Math.random().toString(36).substr(2, 9)}`;

            let html = `<div class="ou-item" style="margin-left: ${level * 20}px;">`;
            html += `<div class="ou-header">`;

            if (hasChildren) {
                html += `<button class="expand-btn collapsed" onclick="toggleOU(this, '${uniqueId}')">+</button>`;
            } else {
                html += `<button class="expand-btn" disabled></button>`;
            }

            html += `<span class="ou-name">${ou.Name}</span>`;

            if (ou.gpos.length > 0) {
                html += `<span class="gpo-count">(${ou.gpos.length} GPO${ou.gpos.length !== 1 ? 's' : ''})</span>`;
            }

            html += `</div>`;

            if (hasChildren) {
                html += `<div class="ou-children" id="${uniqueId}">`;

                // Render GPOs first
                ou.gpos.forEach(({ gpo, wmiInfo }) => {
                    const hasWmi = wmiInfo !== null;
                    html += `<div class="gpo-item">`;
                    html += `<div class="gpo-name ${hasWmi ? 'has-wmi' : ''}">${gpo.DisplayName || 'Unnamed GPO'}</div>`;

                    if (hasWmi) {
                        html += `<div class="wmi-details">`;
                        html += `<div><span class="wmi-name">WMI Filter:</span> ${wmiInfo['msWMI-Name'] || 'Unknown'}</div>`;
                        if (wmiInfo['msWMI-Parm2']) {
                            html += `<div class="wmi-query">${wmiInfo['msWMI-Parm2']}</div>`;
                        }
                        html += `</div>`;
                    }

                    html += `</div>`;
                });

                // Then render child OUs
                ou.children.forEach(child => {
                    html += renderOUNode(child, 0);
                });

                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function renderOUTree() {
            try {
                console.log('Rendering OU tree...');
                const startTime = performance.now();

                const hierarchy = buildOUHierarchy();
                const treeContainer = document.getElementById('ouTree');

                let html = '';
                hierarchy.forEach(ou => {
                    html += renderOUNode(ou);
                });

                treeContainer.innerHTML = html;
                document.getElementById('treeContainer').classList.add('visible');

                const renderTime = (performance.now() - startTime).toFixed(2);
                console.log(`Tree rendered in ${renderTime}ms`);

            } catch (error) {
                console.error('Error rendering tree:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-msg';
                errorDiv.textContent = `Error rendering tree: ${error.message}. Check console for details.`;
                document.getElementById('treeContainer').appendChild(errorDiv);
                document.getElementById('treeContainer').classList.add('visible');
            }
        }

        // Log initial message
        console.log('%cContoso GPO Viewer - Debug Mode Active', 'color: #667eea; font-size: 16px; font-weight: bold;');
        console.log('Monitor this console for performance metrics and debugging information');
    </script>
</body>
</html>