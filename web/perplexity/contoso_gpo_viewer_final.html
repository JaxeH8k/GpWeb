<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contoso GPO Management</title>
    <style>
        :root {
            --scale-factor: 1;
            --font-base: calc(14px * var(--scale-factor));
            --font-large: calc(2em * var(--scale-factor));
            --font-medium: calc(1.1em * var(--scale-factor));
            --font-small: calc(0.9em * var(--scale-factor));
            --font-tiny: calc(0.85em * var(--scale-factor));
            --icon-size: calc(24px * var(--scale-factor));
            --spacing: calc(8px * var(--scale-factor));
            --indent: calc(20px * var(--scale-factor));
            /* Light mode colors */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --hover-bg: #f0f0f0;
            --section-bg: #f8f9fa;
            --gpo-bg: #f8f9fa;
            --gpo-border: #667eea;
            --wmi-bg: #e9ecef;
            --wmi-accent: #764ba2;
            --debug-bg: #f8f9fa;
            --upload-border: #667eea;
            --upload-hover-bg: #f8f9fa;
        }
        [data-theme="dark"] {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: #0f3460;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --text-muted: #a0a0a0;
            --border-color: #2a4a6a;
            --hover-bg: #1a3a5a;
            --section-bg: #1a3a5a;
            --gpo-bg: #1a3a5a;
            --gpo-border: #667eea;
            --wmi-bg: #2a4a6a;
            --wmi-accent: #9b7bbe;
            --debug-bg: #1a3a5a;
            --upload-border: #667eea;
            --upload-hover-bg: #1a3a5a;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: var(--font-base);
            transition: background 0.3s ease;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
            transition: background 0.3s ease;
        }
        h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: var(--font-large);
            transition: color 0.3s ease;
        }
        .welcome {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: var(--font-medium);
            transition: color 0.3s ease;
        }
        .upload-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .upload-box {
            border: 2px dashed var(--upload-border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        .upload-box:hover {
            border-color: #764ba2;
            background: var(--upload-hover-bg);
        }
        .upload-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: calc(1.2em * var(--scale-factor));
        }
        .file-input {
            display: none;
        }
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: calc(10px * var(--scale-factor)) calc(20px * var(--scale-factor));
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: calc(1em * var(--scale-factor));
            transition: transform 0.2s;
        }
        .upload-btn:hover {
            transform: translateY(-2px);
        }
        .status {
            margin-top: 10px;
            font-size: var(--font-small);
            color: #28a745;
        }
        .controls-section {
            background: var(--section-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            transition: all 0.3s ease;
        }
        .controls-section.visible {
            display: block;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group:last-child {
            margin-bottom: 0;
        }
        .control-group label {
            font-weight: 600;
            color: var(--text-primary);
            margin-right: 15px;
            font-size: var(--font-small);
            transition: color 0.3s ease;
        }
        .control-group input[type="radio"] {
            margin-right: 5px;
        }
        .control-group .radio-option {
            display: inline-block;
            margin-right: 15px;
            font-size: var(--font-small);
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        .scale-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .scale-btn, .theme-toggle {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            padding: calc(5px * var(--scale-factor)) calc(12px * var(--scale-factor));
            cursor: pointer;
            font-size: var(--font-small);
            transition: background 0.2s;
        }
        .scale-btn:hover, .theme-toggle:hover {
            background: #764ba2;
        }
        .scale-btn:active, .theme-toggle:active {
            transform: scale(0.95);
        }
        .theme-toggle {
            background: #495057;
        }
        .theme-toggle:hover {
            background: #343a40;
        }
        .scale-value {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 45px;
            text-align: center;
            font-size: var(--font-small);
            transition: color 0.3s ease;
        }
        .debug-info {
            background: var(--debug-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: var(--font-tiny);
            display: none;
            transition: all 0.3s ease;
        }
        .debug-info.visible {
            display: block;
        }
        .tree-container {
            margin-top: 30px;
            display: none;
        }
        .tree-container.visible {
            display: block;
        }
        .ou-item {
            margin: calc(5px * var(--scale-factor)) 0;
        }
        .ou-header {
            display: flex;
            align-items: center;
            padding: var(--spacing);
            border-radius: 5px;
            transition: background 0.2s;
        }
        .ou-header:hover {
            background: var(--hover-bg);
        }
        .ou-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-right: 10px;
            transition: color 0.3s ease;
        }
        .ou-counts {
            color: var(--text-secondary);
            font-size: var(--font-small);
            font-style: italic;
            display: flex;
            gap: 10px;
            transition: color 0.3s ease;
        }
        .desc-gpo-flag {
            color: #764ba2;
            font-size: var(--font-medium);
            margin-left: 8px;
            vertical-align: middle;
            font-family: monospace;
            letter-spacing: 2px;
        }
        .gpo-item {
            padding: var(--spacing) var(--spacing) var(--spacing) calc(32px * var(--scale-factor));
            margin: calc(2px * var(--scale-factor)) 0;
            background: var(--gpo-bg);
            border-left: calc(3px * var(--scale-factor)) solid var(--gpo-border);
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        .gpo-name {
            font-weight: 500;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        .gpo-name.has-wmi {
            font-style: italic;
        }
        .wmi-inline {
            color: var(--wmi-accent);
            font-weight: 600;
            font-size: var(--font-small);
            margin-left: 10px;
            transition: color 0.3s ease;
        }
        .wmi-inline::before { content: "["; }
        .wmi-inline::after { content: "]"; }
        .wmi-details {
            margin-top: calc(5px * var(--scale-factor));
            margin-left: calc(15px * var(--scale-factor));
            font-size: var(--font-tiny);
            color: var(--text-muted);
            line-height: 1.4;
            transition: color 0.3s ease;
        }
        .wmi-query {
            font-family: 'Courier New', monospace;
            background: var(--wmi-bg);
            padding: calc(3px * var(--scale-factor)) calc(6px * var(--scale-factor));
            border-radius: 3px;
            margin-top: calc(3px * var(--scale-factor));
            display: inline-block;
            max-width: 100%;
            word-break: break-all;
            transition: background 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ Contoso Group Policy Management</h1>
        <p class="welcome">Welcome to the enhanced GPO viewer. Upload your JSON files to explore your Active Directory Group Policy infrastructure with improved performance.</p>
        <div class="upload-section">
            <div class="upload-box">
                <h3>üìÅ OU JSON</h3>
                <input type="file" id="ouFile" class="file-input" accept=".json">
                <button class="upload-btn" onclick="document.getElementById('ouFile').click()">Select File</button>
                <div class="status" id="ouStatus"></div>
            </div>
            <div class="upload-box">
                <h3>üìã GPO JSON</h3>
                <input type="file" id="gpoFile" class="file-input" accept=".json">
                <button class="upload-btn" onclick="document.getElementById('gpoFile').click()">Select File</button>
                <div class="status" id="gpoStatus"></div>
            </div>
            <div class="upload-box">
                <h3>üîç WMI JSON</h3>
                <input type="file" id="wmiFile" class="file-input" accept=".json">
                <button class="upload-btn" onclick="document.getElementById('wmiFile').click()">Select File</button>
                <div class="status" id="wmiStatus"></div>
            </div>
        </div>
        <div class="controls-section" id="controlsSection">
            <div class="control-group">
                <label>WMI Filter:</label>
                <span class="radio-option">
                    <input type="radio" name="wmiFilter" value="all" id="filterAll" checked onchange="applyFilters()">
                    <label for="filterAll">Show All</label>
                </span>
                <span class="radio-option">
                    <input type="radio" name="wmiFilter" value="with" id="filterWith" onchange="applyFilters()">
                    <label for="filterWith">With WMI Only</label>
                </span>
                <span class="radio-option">
                    <input type="radio" name="wmiFilter" value="without" id="filterWithout" onchange="applyFilters()">
                    <label for="filterWithout">Without WMI Only</label>
                </span>
            </div>
            <div class="control-group">
                <label>UI Scale:</label>
                <div class="scale-controls">
                    <button class="scale-btn" onclick="adjustScale(-0.1)">‚àí</button>
                    <span class="scale-value" id="scaleValue">100%</span>
                    <button class="scale-btn" onclick="adjustScale(0.1)">+</button>
                    <button class="scale-btn" onclick="resetScale()">Reset</button>
                    <button class="theme-toggle" type="button" onclick="toggleTheme()">üåì Toggle Dark Mode</button>
                </div>
            </div>
        </div>
        <div class="debug-info" id="debugInfo">
            <h3>üìä Debug Information</h3>
            <div id="debugContent"></div>
        </div>
        <div class="tree-container" id="treeContainer">
            <h2>Organizational Unit Hierarchy</h2>
            <div id="ouTree"></div>
        </div>
    </div>
    <script>
        let ouData = null, gpoData = null, wmiData = null;
        let gpoIndex = null, wmiIndex = null, hierarchyData = null;
        let currentScale = 1.0; let isDarkMode = false;
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark'); isDarkMode = true;
        }
        document.getElementById('ouFile').addEventListener('change', e => handleFileUpload(e, 'ou'));
        document.getElementById('gpoFile').addEventListener('change', e => handleFileUpload(e, 'gpo'));
        document.getElementById('wmiFile').addEventListener('change', e => handleFileUpload(e, 'wmi'));
        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    switch(type) {
                        case 'ou': ouData = data; document.getElementById('ouStatus').textContent = `‚úì ${file.name} (${data.length} OUs)`; break;
                        case 'gpo': gpoData = data; buildGPOIndex(); document.getElementById('gpoStatus').textContent = `‚úì ${file.name} (${data.length} GPOs)`; break;
                        case 'wmi': wmiData = data; buildWMIIndex(); document.getElementById('wmiStatus').textContent = `‚úì ${file.name} (${data.length} filters)`; break;
                    }
                    if (ouData && gpoData && wmiData) {
                        renderOUTree();
                        document.getElementById('controlsSection').classList.add('visible');
                    }
                } catch (error) { alert(`Error parsing ${file.name}: ${error.message}`); }
            };
            reader.readAsText(file);
        }
        function buildGPOIndex() { gpoIndex = new Map(); gpoData.forEach(gpo => { if (gpo.Id) { const id = gpo.Id.replace(/[{}]/g, '').toLowerCase(); gpoIndex.set(id, gpo); gpoIndex.set(`{${id}}`, gpo); }}); }
        function buildWMIIndex() { wmiIndex = new Map(); wmiData.forEach(wmi => { if (wmi['msWMI-ID']) { const id = wmi['msWMI-ID'].replace(/[{}]/g, '').toLowerCase(); wmiIndex.set(id, wmi); wmiIndex.set(`{${id}}`, wmi); }}); }
        function extractGuidFromPath(path) { const match = path.match(/\{([^}]+)\}/); return match ? match[1] : null; }
        function findGPO(guid) { if (!guid || !gpoIndex) return null; const id = guid.replace(/[{}]/g, '').toLowerCase(); return gpoIndex.get(id) || gpoIndex.get(`{${id}}`) || null; }
        function findWMI(guid) { if (!guid || !wmiIndex) return null; const id = guid.replace(/[{}]/g, '').toLowerCase(); return wmiIndex.get(id) || wmiIndex.get(`{${id}}`) || null; }
        function buildOUHierarchy() {
            const ouMap = new Map();
            ouData.forEach(ou => {
                const ouPath = `OU=${ou.Name},${ou.Parent}`;
                ouMap.set(ouPath, { ...ou, fullPath: ouPath, children: [], gpos: [], hasDescendantGpo: false });
            });
            ouData.forEach(ou => {
                const ouPath = `OU=${ou.Name},${ou.Parent}`;
                const ouNode = ouMap.get(ouPath);
                ouData.forEach(childOU => {
                    if (childOU.Parent === ouPath) {
                        const childPath = `OU=${childOU.Name},${childOU.Parent}`;
                        ouNode.children.push(ouMap.get(childPath));
                    }
                });
                if (ou.LinkedGPO && ou.LinkedGPO.length > 0) {
                    ou.LinkedGPO.forEach(gpoPath => {
                        const guid = extractGuidFromPath(gpoPath);
                        const gpo = findGPO(guid);
                        if (gpo) ouNode.gpos.push(gpo);
                    });
                }
            });
            // recursively mark descendants
            function markDescGpo(node) {
                let hasDesc = false;
                node.children.forEach(child => {
                    if (child.gpos && child.gpos.length > 0) hasDesc = true;
                    if (markDescGpo(child)) hasDesc = true;
                });
                node.hasDescendantGpo = hasDesc;
                return hasDesc;
            }
            let roots = [];
            ouMap.forEach(ouNode => { if (ouNode.fullPath.startsWith('OU=') && ouNode.Parent.startsWith('DC=')) roots.push(ouNode); });
            roots.forEach(root => markDescGpo(root));
            return roots;
        }
        function renderOUNode(ou, level = 0) {
            const indent = 20 * level;
            let html = `<div class='ou-item' style='margin-left:${indent}px'>`;
            html += `<div class='ou-header'>`;
            html += `<span class='ou-name'>${ou.Name}</span>`;
            html += `<span class='ou-counts'>(${ou.gpos.length} GPO${ou.gpos.length!=1?"s":""})`;
            if (ou.hasDescendantGpo) html += ` <span class='desc-gpo-flag'>[‚§µ]</span>`;
            html += `</span>`;
            html += `</div>`;
            if (ou.gpos.length > 0) {
                ou.gpos.forEach(gpo => {
                    const hasWmi = gpo.WmiFilter && gpo.WmiFilter.Path;
                    let wmiInfo = null;
                    if (hasWmi) {
                        const wmiGuid = extractGuidFromPath(gpo.WmiFilter.Path);
                        wmiInfo = findWMI(wmiGuid);
                    }
                    html += `<div class='gpo-item'>`;
                    html += `<div class='gpo-name${hasWmi ? " has-wmi" : ""}'>${gpo.DisplayName||'Unnamed GPO'}`;
                    if (wmiInfo) html += `<span class='wmi-inline'>${wmiInfo['msWMI-Name']||'Unknown'}</span>`;
                    html += `</div>`;
                    if (wmiInfo && wmiInfo['msWMI-Parm2'])
                        html += `<div class='wmi-details'><div class='wmi-query'>${wmiInfo['msWMI-Parm2']}</div></div>`;
                    html += `</div>`;
                });
            }
            if (ou.children.length > 0) {
                ou.children.forEach(child => {
                    html += renderOUNode(child, level+1);
                });
            }
            html += `</div>`;
            return html;
        }
        function renderOUTree() {
            hierarchyData = buildOUHierarchy();
            const treeDiv = document.getElementById('ouTree');
            let html = '';
            hierarchyData.forEach(ou => { html += renderOUNode(ou, 0); });
            treeDiv.innerHTML = html;
            document.getElementById('treeContainer').classList.add('visible');
        }
        function applyFilters() { /* No-op for GPO filtering; left for completeness */ }
        function adjustScale(delta) {
            currentScale = Math.max(0.5, Math.min(2.0, currentScale + delta));
            applyScale();
        }
        function resetScale() { currentScale = 1.0; applyScale(); }
        function applyScale() {
            document.documentElement.style.setProperty('--scale-factor', currentScale);
            document.getElementById('scaleValue').textContent = `${Math.round(currentScale*100)}%`;
        }
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) { document.documentElement.setAttribute('data-theme', 'dark'); localStorage.setItem('theme','dark'); }
            else { document.documentElement.removeAttribute('data-theme'); localStorage.setItem('theme','light'); }
        }
    </script>
</body>
</html>