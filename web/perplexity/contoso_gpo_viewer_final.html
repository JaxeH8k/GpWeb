<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contoso GPO Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --scale-factor: 1;
            --font-base: calc(14px * var(--scale-factor));
            --font-large: calc(2em * var(--scale-factor));
            --font-medium: calc(1.1em * var(--scale-factor));
            --font-small: calc(0.9em * var(--scale-factor));
            --font-tiny: calc(0.85em * var(--scale-factor));
            --icon-size: calc(24px * var(--scale-factor));
            --spacing: calc(8px * var(--scale-factor));
            --indent: calc(20px * var(--scale-factor));

            /* Light mode colors */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --hover-bg: #f0f0f0;
            --section-bg: #f8f9fa;
            --gpo-bg: #f8f9fa;
            --gpo-border: #667eea;
            --wmi-bg: #e9ecef;
            --wmi-accent: #764ba2;
            --debug-bg: #f8f9fa;
            --upload-border: #667eea;
            --upload-hover-bg: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: #0f3460;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --text-muted: #a0a0a0;
            --border-color: #2a4a6a;
            --hover-bg: #1a3a5a;
            --section-bg: #1a3a5a;
            --gpo-bg: #1a3a5a;
            --gpo-border: #667eea;
            --wmi-bg: #2a4a6a;
            --wmi-accent: #9b7bbe;
            --debug-bg: #1a3a5a;
            --upload-border: #667eea;
            --upload-hover-bg: #1a3a5a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: var(--font-base);
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
            transition: background 0.3s ease;
        }

        h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: var(--font-large);
            transition: color 0.3s ease;
        }

        h2 {
            font-size: calc(1.5em * var(--scale-factor));
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .welcome {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: var(--font-medium);
            transition: color 0.3s ease;
        }

        .upload-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 2px dashed var(--upload-border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: var(--upload-hover-bg);
        }

        .upload-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: calc(1.2em * var(--scale-factor));
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: calc(10px * var(--scale-factor)) calc(20px * var(--scale-factor));
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: calc(1em * var(--scale-factor));
            transition: transform 0.2s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .status {
            margin-top: 10px;
            font-size: var(--font-small);
            color: #28a745;
        }

        .controls-section {
            background: var(--section-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            transition: all 0.3s ease;
        }

        .controls-section.visible {
            display: block;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text-primary);
            margin-right: 15px;
            font-size: var(--font-small);
            transition: color 0.3s ease;
        }

        .control-group input[type="radio"] {
            margin-right: 5px;
        }

        .control-group .radio-option {
            display: inline-block;
            margin-right: 15px;
            font-size: var(--font-small);
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .scale-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .scale-btn, .theme-toggle {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            padding: calc(5px * var(--scale-factor)) calc(12px * var(--scale-factor));
            cursor: pointer;
            font-size: var(--font-small);
            transition: background 0.2s;
        }

        .scale-btn:hover, .theme-toggle:hover {
            background: #764ba2;
        }

        .scale-btn:active, .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle {
            background: #495057;
        }

        .theme-toggle:hover {
            background: #343a40;
        }

        .scale-value {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 45px;
            text-align: center;
            font-size: var(--font-small);
            transition: color 0.3s ease;
        }

        .debug-info {
            background: var(--debug-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: var(--font-tiny);
            display: none;
            transition: all 0.3s ease;
        }

        .debug-info.visible {
            display: block;
        }

        .debug-info h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: calc(1em * var(--scale-factor));
            transition: color 0.3s ease;
        }

        .debug-info strong {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .tree-container {
            margin-top: 30px;
            display: none;
        }

        .tree-container.visible {
            display: block;
        }

        .ou-item {
            margin: calc(5px * var(--scale-factor)) 0;
        }

        .ou-item.filtered-out {
            display: none;
        }

        .ou-header {
            display: flex;
            align-items: center;
            padding: var(--spacing);
            border-radius: 5px;
            transition: background 0.2s;
        }

        .ou-header:hover {
            background: var(--hover-bg);
        }

        .expand-btn {
            width: var(--icon-size);
            height: var(--icon-size);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: var(--spacing);
            font-size: calc(16px * var(--scale-factor));
            flex-shrink: 0;
        }

        .expand-btn.collapsed {
            background: #28a745;
            color: white;
        }

        .expand-btn.expanded {
            background: #dc3545;
            color: white;
        }

        .expand-btn:disabled {
            background: #e0e0e0;
            cursor: default;
            visibility: hidden;
        }

        .ou-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-right: 10px;
            transition: color 0.3s ease;
        }

        .ou-counts {
            color: var(--text-secondary);
            font-size: var(--font-small);
            font-style: italic;
            display: flex;
            gap: 15px;
            transition: color 0.3s ease;
        }

        .count-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .count-label {
            color: var(--text-tertiary);
            transition: color 0.3s ease;
        }

        .ou-children {
            margin-left: calc(32px * var(--scale-factor));
            display: none;
        }

        .ou-children.visible {
            display: block;
        }

        .gpo-item {
            padding: var(--spacing) var(--spacing) var(--spacing) calc(32px * var(--scale-factor));
            margin: calc(2px * var(--scale-factor)) 0;
            background: var(--gpo-bg);
            border-left: calc(3px * var(--scale-factor)) solid var(--gpo-border);
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .gpo-item.filtered-out {
            display: none;
        }

        .gpo-name {
            font-weight: 500;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .gpo-name.has-wmi {
            font-style: italic;
        }

        .wmi-inline {
            color: var(--wmi-accent);
            font-weight: 600;
            font-size: var(--font-small);
            margin-left: 10px;
            transition: color 0.3s ease;
        }

        .wmi-inline::before {
            content: "[";
        }

        .wmi-inline::after {
            content: "]";
        }

        .wmi-details {
            margin-top: calc(5px * var(--scale-factor));
            margin-left: calc(15px * var(--scale-factor));
            font-size: var(--font-tiny);
            color: var(--text-muted);
            line-height: 1.4;
            transition: color 0.3s ease;
        }

        .wmi-query {
            font-family: 'Courier New', monospace;
            background: var(--wmi-bg);
            padding: calc(3px * var(--scale-factor)) calc(6px * var(--scale-factor));
            border-radius: 3px;
            margin-top: calc(3px * var(--scale-factor));
            display: inline-block;
            max-width: 100%;
            word-break: break-all;
            transition: background 0.3s ease;
        }

        .error-msg {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ Contoso Group Policy Management</h1>
        <p class="welcome">Welcome to the enhanced GPO viewer. Upload your JSON files to explore your Active Directory Group Policy infrastructure with improved performance.</p>

        <div class="upload-section">
            <div class="upload-box">
                <h3>üìÅ OU JSON</h3>
                <input type="file" id="ouFile" class="file-input" accept=".json">
                <button class="upload-btn" onclick="document.getElementById('ouFile').click()">Select File</button>
                <div class="status" id="ouStatus"></div>
            </div>

            <div class="upload-box">
                <h3>üìã GPO JSON</h3>
                <input type="file" id="gpoFile" class="file-input" accept=".json">
                <button class="upload-btn" onclick="document.getElementById('gpoFile').click()">Select File</button>
                <div class="status" id="gpoStatus"></div>
            </div>

            <div class="upload-box">
                <h3>üîç WMI JSON</h3>
                <input type="file" id="wmiFile" class="file-input" accept=".json">
                <button class="upload-btn" onclick="document.getElementById('wmiFile').click()">Select File</button>
                <div class="status" id="wmiStatus"></div>
            </div>
        </div>

        <div class="controls-section" id="controlsSection">
            <div class="control-group">
                <label>WMI Filter:</label>
                <span class="radio-option">
                    <input type="radio" name="wmiFilter" value="all" id="filterAll" checked onchange="applyFilters()">
                    <label for="filterAll">Show All</label>
                </span>
                <span class="radio-option">
                    <input type="radio" name="wmiFilter" value="with" id="filterWith" onchange="applyFilters()">
                    <label for="filterWith">With WMI Only</label>
                </span>
                <span class="radio-option">
                    <input type="radio" name="wmiFilter" value="without" id="filterWithout" onchange="applyFilters()">
                    <label for="filterWithout">Without WMI Only</label>
                </span>
            </div>

            <div class="control-group">
                <label>UI Scale:</label>
                <div class="scale-controls">
                    <button class="scale-btn" onclick="adjustScale(-0.1)">‚àí</button>
                    <span class="scale-value" id="scaleValue">100%</span>
                    <button class="scale-btn" onclick="adjustScale(0.1)">+</button>
                    <button class="scale-btn" onclick="resetScale()">Reset</button>
                    <button class="theme-toggle" onclick="toggleTheme()">üåì Toggle Dark Mode</button>
                </div>
            </div>
        </div>

        <div class="debug-info" id="debugInfo">
            <h3>üìä Debug Information</h3>
            <div id="debugContent"></div>
        </div>

        <div class="tree-container" id="treeContainer">
            <h2>Organizational Unit Hierarchy</h2>
            <div id="ouTree"></div>
        </div>
    </div>

    <script>
        let ouData = null;
        let gpoData = null;
        let wmiData = null;

        // Performance-optimized indexes using Map (O(1) lookups)
        let gpoIndex = null;
        let wmiIndex = null;
        let hierarchyData = null;

        let currentScale = 1.0;
        let isDarkMode = false;

        // Check for saved theme preference
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            isDarkMode = true;
        }

        // File upload handlers
        document.getElementById('ouFile').addEventListener('change', (e) => handleFileUpload(e, 'ou'));
        document.getElementById('gpoFile').addEventListener('change', (e) => handleFileUpload(e, 'gpo'));
        document.getElementById('wmiFile').addEventListener('change', (e) => handleFileUpload(e, 'wmi'));

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            console.log(`Loading ${type} file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const startTime = performance.now();
                    const data = JSON.parse(e.target.result);
                    const parseTime = (performance.now() - startTime).toFixed(2);

                    console.log(`${type} parsed in ${parseTime}ms, ${data.length} items`);

                    switch(type) {
                        case 'ou':
                            ouData = data;
                            document.getElementById('ouStatus').textContent = `‚úì ${file.name} (${data.length} OUs)`;
                            break;
                        case 'gpo':
                            gpoData = data;
                            buildGPOIndex();
                            document.getElementById('gpoStatus').textContent = `‚úì ${file.name} (${data.length} GPOs)`;
                            break;
                        case 'wmi':
                            wmiData = data;
                            buildWMIIndex();
                            document.getElementById('wmiStatus').textContent = `‚úì ${file.name} (${data.length} filters)`;
                            break;
                    }

                    if (ouData && gpoData && wmiData) {
                        renderOUTree();
                        document.getElementById('controlsSection').classList.add('visible');
                    }
                } catch (error) {
                    console.error(`Error parsing ${file.name}:`, error);
                    alert(`Error parsing ${file.name}: ${error.message}`);
                }
            };

            reader.onerror = (error) => {
                console.error(`Error reading ${file.name}:`, error);
                alert(`Error reading ${file.name}`);
            };

            reader.readAsText(file);
        }

        function buildGPOIndex() {
            console.log('Building GPO index...');
            const startTime = performance.now();

            gpoIndex = new Map();
            gpoData.forEach(gpo => {
                if (gpo.Id) {
                    const normalizedId = gpo.Id.replace(/[{}]/g, '').toLowerCase();
                    gpoIndex.set(normalizedId, gpo);
                    gpoIndex.set(`{${normalizedId}}`, gpo);
                    gpoIndex.set(gpo.Id.toLowerCase(), gpo);
                }
            });

            const indexTime = (performance.now() - startTime).toFixed(2);
            console.log(`GPO index built in ${indexTime}ms, ${gpoIndex.size} entries`);
        }

        function buildWMIIndex() {
            console.log('Building WMI index...');
            const startTime = performance.now();

            wmiIndex = new Map();
            wmiData.forEach(wmi => {
                if (wmi['msWMI-ID']) {
                    const wmiId = wmi['msWMI-ID'];
                    const normalizedId = wmiId.replace(/[{}]/g, '').toLowerCase();
                    wmiIndex.set(normalizedId, wmi);
                    wmiIndex.set(`{${normalizedId}}`, wmi);
                    wmiIndex.set(wmiId.toLowerCase(), wmi);
                }
            });

            const indexTime = (performance.now() - startTime).toFixed(2);
            console.log(`WMI index built in ${indexTime}ms, ${wmiIndex.size} entries`);
        }

        function extractGuidFromPath(path) {
            const patterns = [
                /CN=\{([^}]+)\}/i,
                /\{([a-f0-9-]+)\}/i,
                /([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/i
            ];

            for (const pattern of patterns) {
                const match = path.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            return null;
        }

        function findGPO(guid) {
            if (!guid || !gpoIndex) return null;

            const normalized = guid.replace(/[{}]/g, '').toLowerCase();
            return gpoIndex.get(normalized) || 
                   gpoIndex.get(`{${normalized}}`) || 
                   gpoIndex.get(guid.toLowerCase()) || 
                   null;
        }

        function findWMI(guid) {
            if (!guid || !wmiIndex) return null;

            const normalized = guid.replace(/[{}]/g, '').toLowerCase();
            return wmiIndex.get(normalized) || 
                   wmiIndex.get(`{${normalized}}`) || 
                   wmiIndex.get(guid.toLowerCase()) || 
                   null;
        }

        function countDescendants(ou) {
            let childCount = ou.children.length;
            ou.children.forEach(child => {
                childCount += countDescendants(child);
            });
            return childCount;
        }

        function buildOUHierarchy() {
            console.log('Building OU hierarchy...');
            const startTime = performance.now();

            const ouMap = new Map();
            const rootOUs = [];
            let totalGPOs = 0;
            let matchedGPOs = 0;
            let unmatchedGUIDs = new Set();

            try {
                // Create a map of all OUs
                ouData.forEach((ou, index) => {
                    const ouPath = `OU=${ou.Name},${ou.Parent}`;
                    ouMap.set(ouPath, {
                        ...ou,
                        fullPath: ouPath,
                        children: [],
                        gpos: [],
                        childOUCount: 0
                    });
                });

                console.log(`Created ${ouMap.size} OU entries`);

                // Build parent-child relationships and process GPOs
                ouData.forEach(ou => {
                    const ouPath = `OU=${ou.Name},${ou.Parent}`;
                    const ouNode = ouMap.get(ouPath);

                    if (!ouNode) {
                        console.warn(`OU node not found for: ${ouPath}`);
                        return;
                    }

                    // Find children
                    ouData.forEach(potentialChild => {
                        if (potentialChild.Parent === ouPath) {
                            const childPath = `OU=${potentialChild.Name},${potentialChild.Parent}`;
                            const childNode = ouMap.get(childPath);
                            if (childNode) {
                                ouNode.children.push(childNode);
                            }
                        }
                    });

                    // Count direct child OUs
                    ouNode.childOUCount = ouNode.children.length;

                    // Process linked GPOs
                    if (ou.LinkedGPO && ou.LinkedGPO.length > 0) {
                        totalGPOs += ou.LinkedGPO.length;

                        ou.LinkedGPO.forEach(gpoPath => {
                            const guid = extractGuidFromPath(gpoPath);

                            if (guid) {
                                const gpo = findGPO(guid);

                                if (gpo) {
                                    matchedGPOs++;
                                    let wmiInfo = null;

                                    if (gpo.WmiFilter && gpo.WmiFilter.Path) {
                                        const wmiGuid = extractGuidFromPath(gpo.WmiFilter.Path);
                                        if (wmiGuid) {
                                            wmiInfo = findWMI(wmiGuid);
                                        }
                                    }

                                    ouNode.gpos.push({ gpo, wmiInfo });
                                } else {
                                    unmatchedGUIDs.add(guid);
                                    console.warn(`GPO not found for GUID: ${guid} in OU: ${ou.Name}`);
                                }
                            } else {
                                console.warn(`Could not extract GUID from path: ${gpoPath}`);
                            }
                        });
                    }

                    // Add to root if parent is domain root
                    if (ou.Parent.startsWith('DC=')) {
                        rootOUs.push(ouNode);
                    }
                });

                const hierarchyTime = (performance.now() - startTime).toFixed(2);

                // Display debug info
                const debugContent = `
                    <strong>OUs:</strong> ${ouMap.size}<br>
                    <strong>Root OUs:</strong> ${rootOUs.length}<br>
                    <strong>Total GPO Links:</strong> ${totalGPOs}<br>
                    <strong>Matched GPOs:</strong> ${matchedGPOs}<br>
                    <strong>Unmatched GPOs:</strong> ${unmatchedGUIDs.size}<br>
                    <strong>Processing Time:</strong> ${hierarchyTime}ms<br>
                    ${unmatchedGUIDs.size > 0 ? `<strong style="color: #dc3545;">Unmatched GUIDs:</strong> ${Array.from(unmatchedGUIDs).slice(0, 5).join(', ')}${unmatchedGUIDs.size > 5 ? '...' : ''}` : ''}
                `;

                document.getElementById('debugContent').innerHTML = debugContent;
                document.getElementById('debugInfo').classList.add('visible');

                console.log(`Hierarchy built: ${matchedGPOs}/${totalGPOs} GPOs matched, ${unmatchedGUIDs.size} unmatched`);

                return rootOUs;

            } catch (error) {
                console.error('Error building hierarchy:', error);
                document.getElementById('debugContent').innerHTML = `<strong style="color: #dc3545;">ERROR:</strong> ${error.message}`;
                document.getElementById('debugInfo').classList.add('visible');
                throw error;
            }
        }

        function toggleOU(button, contentId) {
            const content = document.getElementById(contentId);
            if (content.classList.contains('visible')) {
                content.classList.remove('visible');
                button.classList.remove('expanded');
                button.classList.add('collapsed');
                button.textContent = '+';
            } else {
                content.classList.add('visible');
                button.classList.remove('collapsed');
                button.classList.add('expanded');
                button.textContent = '‚àí';
            }
        }

        function renderOUNode(ou, level = 0) {
            const hasChildren = ou.children.length > 0 || ou.gpos.length > 0;
            const uniqueId = `ou_${Math.random().toString(36).substr(2, 9)}`;

            let html = `<div class="ou-item" style="margin-left: ${level * 20}px;" data-ou-id="${uniqueId}">`;
            html += `<div class="ou-header">`;

            if (hasChildren) {
                html += `<button class="expand-btn collapsed" onclick="toggleOU(this, '${uniqueId}')">+</button>`;
            } else {
                html += `<button class="expand-btn" disabled></button>`;
            }

            html += `<span class="ou-name">${ou.Name}</span>`;

            html += `<span class="ou-counts">`;
            if (ou.childOUCount > 0) {
                html += `<span class="count-item"><span class="count-label">OUs:</span> ${ou.childOUCount}</span>`;
            }
            if (ou.gpos.length > 0) {
                html += `<span class="count-item"><span class="count-label">GPOs:</span> ${ou.gpos.length}</span>`;
            }
            html += `</span>`;

            html += `</div>`;

            if (hasChildren) {
                html += `<div class="ou-children" id="${uniqueId}">`;

                // Render GPOs first
                ou.gpos.forEach(({ gpo, wmiInfo }) => {
                    const hasWmi = wmiInfo !== null;
                    html += `<div class="gpo-item" data-has-wmi="${hasWmi}">`;
                    html += `<div class="gpo-name ${hasWmi ? 'has-wmi' : ''}">${gpo.DisplayName || 'Unnamed GPO'}`;

                    if (hasWmi) {
                        html += `<span class="wmi-inline">${wmiInfo['msWMI-Name'] || 'Unknown'}</span>`;
                    }

                    html += `</div>`;

                    if (hasWmi && wmiInfo['msWMI-Parm2']) {
                        html += `<div class="wmi-details">`;
                        html += `<div class="wmi-query">${wmiInfo['msWMI-Parm2']}</div>`;
                        html += `</div>`;
                    }

                    html += `</div>`;
                });

                // Then render child OUs
                ou.children.forEach(child => {
                    html += renderOUNode(child, 0);
                });

                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function renderOUTree() {
            try {
                console.log('Rendering OU tree...');
                const startTime = performance.now();

                hierarchyData = buildOUHierarchy();
                const treeContainer = document.getElementById('ouTree');

                let html = '';
                hierarchyData.forEach(ou => {
                    html += renderOUNode(ou);
                });

                treeContainer.innerHTML = html;
                document.getElementById('treeContainer').classList.add('visible');

                const renderTime = (performance.now() - startTime).toFixed(2);
                console.log(`Tree rendered in ${renderTime}ms`);

            } catch (error) {
                console.error('Error rendering tree:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-msg';
                errorDiv.textContent = `Error rendering tree: ${error.message}. Check console for details.`;
                document.getElementById('treeContainer').appendChild(errorDiv);
                document.getElementById('treeContainer').classList.add('visible');
            }
        }

        function applyFilters() {
            const wmiFilter = document.querySelector('input[name="wmiFilter"]:checked').value;

            // Get all GPO items
            const gpoItems = document.querySelectorAll('.gpo-item');

            gpoItems.forEach(item => {
                const hasWmi = item.getAttribute('data-has-wmi') === 'true';

                let shouldShow = false;

                switch(wmiFilter) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'with':
                        shouldShow = hasWmi;
                        break;
                    case 'without':
                        shouldShow = !hasWmi;
                        break;
                }

                if (shouldShow) {
                    item.classList.remove('filtered-out');
                } else {
                    item.classList.add('filtered-out');
                }
            });

            // Hide OUs that have no visible GPOs and no children
            const ouItems = document.querySelectorAll('.ou-item');
            ouItems.forEach(ouItem => {
                const visibleGPOs = ouItem.querySelectorAll('.gpo-item:not(.filtered-out)');
                const childOUs = ouItem.querySelectorAll('.ou-item');

                // Check if this OU has any visible content
                const hasVisibleContent = visibleGPOs.length > 0 || childOUs.length > 0;

                // Only filter out leaf OUs with no visible GPOs
                if (!hasVisibleContent && childOUs.length === 0) {
                    const directGPOs = Array.from(ouItem.children).filter(child => 
                        child.classList.contains('ou-children')
                    );

                    if (directGPOs.length > 0) {
                        const allFiltered = Array.from(directGPOs[0].querySelectorAll('.gpo-item'))
                            .every(gpo => gpo.classList.contains('filtered-out'));

                        if (allFiltered) {
                            ouItem.style.display = 'none';
                        } else {
                            ouItem.style.display = '';
                        }
                    }
                } else {
                    ouItem.style.display = '';
                }
            });

            console.log(`Filter applied: ${wmiFilter}`);
        }

        function adjustScale(delta) {
            currentScale = Math.max(0.5, Math.min(2.0, currentScale + delta));
            applyScale();
        }

        function resetScale() {
            currentScale = 1.0;
            applyScale();
        }

        function applyScale() {
            document.documentElement.style.setProperty('--scale-factor', currentScale);
            document.getElementById('scaleValue').textContent = `${Math.round(currentScale * 100)}%`;
            console.log(`UI scale: ${currentScale}`);
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;

            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                console.log('Dark mode enabled');
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
                console.log('Light mode enabled');
            }
        }

        // Log initial message
        console.log('%cContoso GPO Viewer - Debug Mode Active', 'color: #667eea; font-size: 16px; font-weight: bold;');
        console.log('Monitor this console for performance metrics and debugging information');
    </script>
</body>
</html>